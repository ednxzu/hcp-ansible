---
name: end-to-end-tests-full-cluster
on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
    branches:
      - main
    paths:
      - .gitea/workflows/e2e-tests-nomad-cluster.yml
      - playbooks/**
      - roles/**
      - plugins/**
      - molecule/nomad_cluster__**

env:
  OS_CLOUD: pcp-w3rxsrj-dc4-a

jobs:
  retrieve-credentials:
    name: Retrieve Credentials
    runs-on: ubuntu-latest
    outputs:
      registry-username: ${{ steps.import-secrets.outputs.GITEA_ACTIONS_USERNAME }}
      registry-token: ${{ steps.import-secrets.outputs.GITEA_ACTIONS_TOKEN }}
      vault-token: ${{ steps.generate-vault-token.outputs.VAULT_TOKEN }}
    steps:
      - name: Get secrets from vault
        id: import-secrets
        uses: hashicorp/vault-action@v3
        with:
          url: "https://vault.ednz.fr"
          method: approle
          roleId: ${{ secrets.VAULT_APPROLE_ID }}
          secretId: ${{ secrets.VAULT_APPROLE_SECRET_ID }}
          secrets: |
            kv/data/applications/gitea/users/actions username | GITEA_ACTIONS_USERNAME ;
            kv/data/applications/gitea/users/actions token_write | GITEA_ACTIONS_TOKEN ;

      - name: Generate Vault token
        id: generate-vault-token
        run: |
          VAULT_TOKEN=$(curl --silent --request POST --data '{"role_id": "${{ secrets.VAULT_APPROLE_ID }}","secret_id": "${{ secrets.VAULT_APPROLE_SECRET_ID }}"}' https://vault.ednz.fr/v1/auth/approle/login | jq -r .auth.client_token)

          echo "vault_token=$VAULT_TOKEN" >> $GITHUB_OUTPUT

  end_to_end_test:
    name: End to End Test
    runs-on: ubuntu-latest
    container:
      image: git.ednz.fr/container-factory/ansible-runner:act-latest
      credentials:
        username: ${{ needs.retrieve-credentials.outputs.registry-username }}
        password: ${{ needs.retrieve-credentials.outputs.registry-token }}
    needs: retrieve-credentials
    strategy:
      matrix:
        test_config:
          # - test_os: "Debian 12 bookworm"
          #   test_user: "debian"
          - test_os: "Debian 13 trixie"
            test_user: "debian"
          # - test_os: "Ubuntu 20.04 LTS Focal Fossa"
          #   test_user: "ubuntu"
          # - test_os: "Ubuntu 22.04 LTS Jammy Jellyfish"
          #   test_user: "ubuntu"
          - test_os: "Ubuntu 24.04 LTS Noble Numbat"
            test_user: "ubuntu"
        scenario:
          - nomad_cluster__tls_multi_node__openstack
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate OpenStack cloud file
        uses: https://git.ednz.fr/github-actions/library/.gitea/actions/generate-cloud-config@v0.4.1
        with:
          vault_addr: https://vault.ednz.fr
          vault_token: ${{ needs.retrieve-credentials.outputs.vault-token }}

      - name: Run Molecule tests
        run: molecule test -s ${{ matrix.scenario }}
        shell: bash
        env:
          ANSIBLE_HOST_KEY_CHECKING: "false"
          ANSIBLE_FORCE_COLOR: "true"
          MOLECULE_TEST_OS: ${{ matrix.test_config.test_os }}
          MOLECULE_TEST_USER: ${{ matrix.test_config.test_user }}
